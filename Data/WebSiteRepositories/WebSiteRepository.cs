using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AutoWebPentester.API.Model;

using Microsoft.EntityFrameworkCore;

namespace AutoWebPentester.API.Data.WebSiteRepositories
{
    public class WebSiteRepository : IWebSiteRepository
    {
        private readonly DataContext _context;

        public WebSiteRepository(DataContext context)
        {
            _context = context;
        }

        public async Task<WebSite> AddWebSite(WebSite webSite,int userId)
        {
            if(await WebSiteExists(webSite)){
                var webSiteFromdb= await this.GetByUrl(webSite.Url);
                int webSiteId= webSiteFromdb.Id;
                webSite.Id=webSiteId;
                bool b= await UserWebSiteInterestAlreadyExists(userId,webSiteId);
              //bool b=false;
                if(!b){
                    
                     await _context.UserWebSites.AddAsync(new UserWebSite{
                        UserId=userId,
                        WebSiteId=webSiteId,
                        Date=DateTime.Now
                });
                }else{
                    UserWebSite userwebSiteToUpdate=await this._context.UserWebSites.FirstOrDefaultAsync(x=>x.UserId==userId && x.WebSiteId==webSiteId);
                    userwebSiteToUpdate.Date=DateTime.Now; 
                }
            } else{
                webSite.UserWebSites= new List<UserWebSite>();
                webSite.UserWebSites.Add(new UserWebSite{
                    UserId=userId,
                    WebSiteId=webSite.Id,
                    Date=DateTime.Now
                });
                await _context.WebSites.AddAsync(webSite);
                // context.SaveChanges();
                // await context.UserWebSites.AddAsync(new UserWebSite{
                //     UserId=userId,
                //     WebSiteId=webSite.Id,
                //     Date=DateTime.Now
                // });
            }

             _context.SaveChanges();
            return webSite;
        }

        private async  Task<bool> UserWebSiteInterestAlreadyExists(int userId, int webSiteId)
        {
            return await  this._context.UserWebSites.AnyAsync(x=>x.UserId==userId && x.WebSiteId==webSiteId);
        }

        public async Task<IEnumerable<WebSite>> GetAll(int userId)
        {
          
            return  await _context.WebSites
                    .Where(x=>x.UserWebSites.Any(y=>y.UserId==userId)).ToListAsync();

        }
         public async Task<IEnumerable<WebSite>> GetRecent(int userId)
        {
            var list=
             await this._context.WebSites
                      .Where(x=>x.UserWebSites.Any(y=>y.UserId==userId)).OrderByDescending(x=>x.UserWebSites.FirstOrDefault(y=>y.UserId==userId).Date).Take(10).ToListAsync();
            return list;
        }

       

        public async Task<WebSite> GetByUrl(string url)
        {
            return await _context.WebSites.FirstOrDefaultAsync(x=>x.Url.Equals(url));
        }

       

        public async Task<WebSite> Remove(WebSite webSite, int userId)
        {
            UserWebSite userWebSite= await _context.UserWebSites.FirstOrDefaultAsync(x=>x.WebSiteId==webSite.Id & x.UserId==userId);
             _context.UserWebSites.Remove(userWebSite);
            await _context.SaveChangesAsync();
            return webSite;

        }

        public async Task<bool> WebSiteExists(WebSite webSite)
        {
            return await  _context.WebSites.AnyAsync(x=>x.Url.Equals(webSite.Url));
        }

        
    }
}