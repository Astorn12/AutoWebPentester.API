using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using AutoWebPentester.API.Data.ResourcesRepository;
using AutoWebPentester.API.DTOs;
using AutoWebPentester.API.Logic.AllWithPentests.Inputs;
using AutoWebPentester.API.Logic.AllWithPentests.Outcomes;
using AutoWebPentester.API.Logic.AllWithPentests.Resources;
using AutoWebPentester.API.Model;
using AutoWebPentester.API.Services.RequestServices;
using Newtonsoft.Json;

namespace AutoWebPentester.API.Logic.AllWithPentests.Caretakers
{
    public class InputsDetector : Caretaker
    {
        public async Task<Outcome> CarryOnPentest(WebSite website, IResourceRepository resourceRepo, Input input,int userId)
        {
            
            Outcome outcome= new Outcome();
            outcome.DateTime=DateTime.Now;
            HttpRequestService service= new HttpRequestService();

            RequestDto requestDto= new RequestDto();
            requestDto.Method="Head";
            requestDto.Protocol="http";
            requestDto.WebsiteUrl=website.Url;
            
          
            HttpResponseMessage response=await service.MakeRequestForPentest(requestDto);
           
            string content=response.Content.ReadAsStringAsync().Result;
            //  content=@"jbsdf fg fdg df gsg sdg <!-- adsgdfgdsgrgdg -->
            //     sdfs dfg df g dfg<!-- dgdf--> fsdfsdfdsffsfdsfewfwdsfdsf";
            
            
            MatchCollection matches = Regex.Matches(content, @"<input(.*?)>", RegexOptions.Singleline);
         
            List<HttpComment> httpInputs= new List<HttpComment>();
            
            if(httpInputs.Count>0){
                outcome.JSONOutcome=JsonConvert.SerializeObject(new StandardStringOutcome("Znaleziona formularze klienckie"));
            }
            else{
                outcome.JSONOutcome=JsonConvert.SerializeObject(new StandardStringOutcome("Nie znaleziono formularzy klieckich."));
            }
               
          
            return outcome;
        }

        public IEnumerable<Input> FillInput(WebSite website,IResourceRepository resourceRepo,IEnumerable<Input> inputs,int userId)
        {
         return null;
        }
    }
}