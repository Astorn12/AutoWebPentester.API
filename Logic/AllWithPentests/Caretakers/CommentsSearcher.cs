using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using AutoWebPentester.API.Data.ResourcesRepository;
using AutoWebPentester.API.DTOs;
using AutoWebPentester.API.Logic.AllWithPentests.Inputs;
using AutoWebPentester.API.Logic.AllWithPentests.Outcomes;
using AutoWebPentester.API.Logic.AllWithPentests.Resources;
using AutoWebPentester.API.Model;
using AutoWebPentester.API.Services.RequestServices;
using Newtonsoft.Json;

namespace AutoWebPentester.API.Logic.AllWithPentests.Caretakers
{
    public class CommentsSearcher : Caretaker
    {
        public async Task<Outcome> CarryOnPentest(WebSite website, IResourceRepository repo, Input input,int userId)
        {
            StandardListOutcome standardList= new StandardListOutcome("Znalezione komentarze");

            Outcome outcome= new Outcome();
            outcome.DateTime=DateTime.Now;
            HttpRequestService service= new HttpRequestService();

            RequestDto requestDto= new RequestDto();
            requestDto.Method="Head";
            requestDto.Protocol="http";
            requestDto.WebsiteUrl=website.Url;
            
          
            HttpResponseMessage response=service.MakeRequestForPentest(requestDto).Result;
           
            string content=response.Content.ReadAsStringAsync().Result;
            //  content=@"jbsdf fg fdg df gsg sdg <!-- adsgdfgdsgrgdg -->
            //     sdfs dfg df g dfg<!-- dgdf--> fsdfsdfdsffsfdsfewfwdsfdsf";
            
            
            MatchCollection matches = Regex.Matches(content, @"<!--(.*?)-->", RegexOptions.Singleline);
         
            List<HttpComment> httpComments= new List<HttpComment>();
            
            for(int i=0;i<matches.Count; i++){
                HttpComment comment=new HttpComment();
                comment.Value=matches[i].Value;
                standardList.Add(comment.Value);

                ResourceSketch resourceSketch= await repo.GetResourceSketch("User forms availibility");

                Resource resource= new Resource(resourceSketch,userId);
                resource.Name="Comment in http";
                resource.Content=comment;
                resource.WebSiteId=website.Id;
                await repo.AddResource(resource);

            }

                outcome.JSONOutcome=JsonConvert.SerializeObject(standardList);
                outcome.DateTime=DateTime.Now;
            return outcome;
        }

        public IEnumerable<Input> FillInput(WebSite website,IResourceRepository resourceRepo,IEnumerable<Input> inputs,int userId)
        {
         return null;
        }
    }
}